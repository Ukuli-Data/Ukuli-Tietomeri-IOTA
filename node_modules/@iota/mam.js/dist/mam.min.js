!function(e,r){"object"==typeof exports&&"undefined"!=typeof module?r(exports,require("@iota/converter"),require("@iota/validators"),require("big-integer")):"function"==typeof define&&define.amd?define(["exports","@iota/converter","@iota/validators","big-integer"],r):r((e=e||self).mam={},e.converter,e.validators,e.bigInt)}(this,(function(e,r,t,n){"use strict";n=n&&Object.prototype.hasOwnProperty.call(n,"default")?n.default:n;var i=function(){function e(r){if(void 0===r&&(r=e.NUMBER_OF_ROUNDS),27!==r&&81!==r)throw new Error("Illegal number of rounds. Only `27` and `81` rounds are supported.");this._state=new Int8Array(e.STATE_LENGTH),this._rounds=r}return e.prototype.reset=function(){this._state=new Int8Array(e.STATE_LENGTH)},e.prototype.rate=function(r){return void 0===r&&(r=e.HASH_LENGTH),this._state.slice(0,r)},e.prototype.absorb=function(r,t,n){do{var i=n<e.HASH_LENGTH?n:e.HASH_LENGTH;this._state.set(r.subarray(t,t+i)),this.transform(),n-=e.HASH_LENGTH,t+=i}while(n>0)},e.prototype.squeeze=function(r,t,n){do{var i=n<e.HASH_LENGTH?n:e.HASH_LENGTH;r.set(this._state.subarray(0,i),t),this.transform(),n-=e.HASH_LENGTH,t+=i}while(n>0)},e.prototype.transform=function(){for(var r,t=0,n=0;n<this._rounds;n++){r=this._state.slice();for(var i=0;i<e.STATE_LENGTH;i++)this._state[i]=e.TRUTH_TABLE[r[t]+(r[t+=t<365?364:-365]<<2)+5]}},e.HASH_LENGTH=243,e.STATE_LENGTH=3*e.HASH_LENGTH,e.NUMBER_OF_ROUNDS=81,e.TRUTH_TABLE=[1,0,-1,2,1,-1,0,2,-1,1,0],e}(),s=27*i.HASH_LENGTH;function a(e){var r=new i(27);r.absorb(e,0,e.length);var t=new Int8Array(i.HASH_LENGTH);return r.squeeze(t,0,t.length),t}function o(e,r){var t=r*s,n=new Int8Array(t),a=new Int8Array(t),o=new i(27);o.absorb(e,0,e.length),o.squeeze(n,0,n.length);for(var u=0;u<t/i.HASH_LENGTH;u++){var l=u*i.HASH_LENGTH;o.reset(),o.absorb(n,l,i.HASH_LENGTH),a.set(o.rate(),l)}return a}function u(e,r,t){var n=function(e,r){for(var t=new i(27),n=e.slice(),s=r;s-- >0;)for(var a=0;a<n.length&&n[a]++>=1;a++)n[a]=-1;t.absorb(n,0,n.length);var o=new Int8Array(i.HASH_LENGTH);return t.squeeze(o,0,o.length),o}(e,r);return{address:a(function(e,r){var t=new i(27),n=new i(27),a=new i(27),o=r*s/i.HASH_LENGTH,u=new Int8Array(i.HASH_LENGTH);t.absorb(e,0,e.length);for(var l=0;l<o;l++){t.squeeze(u,0,u.length);for(var c=0;c<27;c++)n.reset(),n.absorb(u,0,u.length),n.squeeze(u,0,u.length);a.absorb(u,0,u.length)}return a.squeeze(u,0,u.length),u}(n,t)),privateKey:o(n,t)}}var l=function(e,r,t,n){this.left=e,this.right=r,this.size=(e?e.size:0)+(r?r.size:0),this.addressTrits=t,this.privateKeyTrits=n},c=function(){function e(e,t,n,i){for(var s=r.trits(e),a=[],o=0;o<n;o++){var c=u(s,t+o,i);a.push(new l(void 0,void 0,c.address,c.privateKey)),a[o].size=1}this.root=this.buildTree(a)}return e.root=function(e,r,t){for(var n=new i(27),s=1,a=Math.ceil(r.length/i.HASH_LENGTH),o=0;o<a;o++){var u=r.slice(o*i.HASH_LENGTH,(o+1)*i.HASH_LENGTH);n.reset(),0==(s&t)?(n.absorb(e,0,e.length),n.absorb(u,0,u.length)):(n.absorb(u,0,u.length),n.absorb(e,0,e.length)),s<<=1,e=n.rate()}return n.rate()},e.prototype.getSubtree=function(e){if(1===this.root.size)return{key:this.root.left&&this.root.left.privateKeyTrits?this.root.left.privateKeyTrits:new Int8Array,leaves:[]};var r,t=[],n=this.root,i=this.root.size;if(e<i)for(;n;){if(!n.left){r=n.privateKeyTrits;break}e<(i=n.left.size)?(t.push(n.right?n.right:n.left),n=n.left):(t.push(n.left),n=n.right,e-=i)}return t.reverse(),{key:r||new Int8Array,leaves:t}},e.prototype.buildTree=function(e){for(var r=[],t=0;t<e.length;t+=2){var n=e[t],s=t+1<e.length?e[t+1]:void 0,a=void 0;if(s){var o=new i(27);o.absorb(n.addressTrits,0,n.addressTrits.length),o.absorb(s.addressTrits,0,s.addressTrits.length),a=new Int8Array(i.HASH_LENGTH),o.squeeze(a,0,a.length)}else a=n.addressTrits;r.push(new l(n,s,a,void 0))}return 1===r.length?r[0]:this.buildTree(r)},e}(),h=new Int8Array([1,0,0,-1]);function f(e){if(0===e)return h;var t=d(v(Math.abs(e),1)),n=new Int8Array(function(e){var r=d(v(Math.abs(e),1));return r+r/3}(e));g(e,n);for(var i=0,s=0,a=0;a<t-3;a+=3){var o=n.slice(a,a+3);if(r.value(o)>=0){i|=1<<s;for(var u=0;u<o.length;u++)n[a+u]=-o[u]}s++}var l=n.slice(t-3,t-3+t);if(r.value(l)<0){i|=1<<s;for(var c=0;c<l.length;c++)n[c+t-3]=-n[c+t-3]}var f=new Int8Array(n.length-t);g(i,f);for(a=0;a<f.length;a++)n[t+a]=f[a];return n}function H(e){if(e.length>=h.length&&e[0]===h[0]&&e[1]===h[1]&&e[2]===h[2]&&e[3]===h[3])return{value:0,end:4};for(var t=function e(t){if(r.value(t.slice(0,3))>0)return 3;return 3+e(t.slice(3))}(e),n=t+t/3,i=r.value(e.slice(t,n)),s=0,a=0;a<t/3;a++){var o=0!=(i>>a&1)?-r.value(e.slice(3*a,3*(a+1))):r.value(e.slice(3*a,3*(a+1)));s+=Math.pow(27,a)*o}return{value:s,end:n}}function d(e){var r=e%3;return 0===r?e:e+3-r}function v(e,r){return e<=r?1:1+v(e,1+3*r)}function g(e,r){var t=function e(r,t,n){switch(r){case 0:return 0;default:var i=Math.floor(r/3),s=r%3;return s>1&&(i+=1,s=-1),t[n]=s,n++,1+e(i,t,n)}}(e,r,0);if(e>=0)return t;for(var n=0;n<r.length;n++)r[n]=-r[n];return t}var b=function(){function e(){}return e.prototype.search=function(e,r,t,n){for(var s=this.prepareTrits(e,n),a=Math.min(t,i.HASH_LENGTH)-n,o=0;0===o;){var u=this.increment(s,n+2*a/3,n+a);a=Math.min(d(n+2*a/3+u),i.HASH_LENGTH)-n;var l={low:s.low.slice(),high:s.high.slice()};this.transform(l),o=this.check(r,l.low,l.high)}return this.trinaryGet(s.low,s.high,a,o)},e.prototype.prepareTrits=function(r,t){var n=this.tritsToBigInt(r,i.STATE_LENGTH);return n.low[t]=e.LOW_0,n.low[t+1]=e.LOW_1,n.low[t+2]=e.LOW_2,n.low[t+3]=e.LOW_3,n.high[t]=e.HIGH_0,n.high[t+1]=e.HIGH_1,n.high[t+2]=e.HIGH_2,n.high[t+3]=e.HIGH_3,n},e.prototype.tritsToBigInt=function(r,t){for(var n={low:[],high:[]},i=0;i<r.length;i++)switch(r[i]){case 0:n.low[i]=e.MAX_VALUE,n.high[i]=e.MAX_VALUE;break;case 1:n.low[i]=e.MIN_VALUE,n.high[i]=e.MAX_VALUE;break;default:n.low[i]=e.MAX_VALUE,n.high[i]=e.MIN_VALUE}if(r.length>=t)return n;for(i=r.length;i<t;i++)n.low[i]=e.MAX_VALUE,n.high[i]=e.MAX_VALUE;return n},e.prototype.increment=function(e,r,t){for(var n=r;n<t;n++){var i=e.low[n],s=e.high[n];if(e.low[n]=s.xor(i),e.high[n]=i,s.and(i.not()).equals(0))return t-r}return t-r+1},e.prototype.transform=function(r){for(var t=0,n=0;n<e.ROUNDS;n++)for(var s={low:r.low.slice(0,i.STATE_LENGTH),high:r.high.slice(0,i.STATE_LENGTH)},a=0;a<i.STATE_LENGTH;a++){var o=s.low[t],u=s.high[t];t+=t<365?364:-365;var l=s.high[t],c=s.low[t].xor(u),h=this.bitWiseNot(l),f=o.or(h).and(c);r.low[a]=this.bitWiseNot(f);var H=o.xor(l);r.high[a]=H.or(f)}},e.prototype.bitWiseNot=function(e){return n(1).shiftLeft(64).subtract(n(1)).subtract(e)},e.prototype.check=function(e,r,t){for(var i=0;i<64;i++){for(var s=0,a=0;a<e;a++){for(var o=243*a/3;o<243*(a+1)/3;o++){var u=n(1).shiftLeft(i);r[o].and(u).equals(0)?s--:t[o].and(u).equals(0)&&s++}if(0===s&&a<e-1){s=1;break}}if(0===s)return i}return 0},e.prototype.trinaryGet=function(e,r,t,i){for(var s=new Int8Array(t),a=0;a<t;a++){var o=n(i),u=e[a].shiftRight(o).and(1),l=r[a].shiftRight(o).and(1);u.equals(1)&&l.equals(0)?s[a]=-1:u.equals(0)&&l.equals(1)?s[a]=1:s[a]=0}return s},e.MAX_VALUE=n("FFFFFFFFFFFFFFFF",16),e.MIN_VALUE=n("0000000000000000",16),e.HIGH_0=n("B6DB6DB6DB6DB6DB",16),e.HIGH_1=n("8FC7E3F1F8FC7E3F",16),e.HIGH_2=n("FFC01FFFF803FFFF",16),e.HIGH_3=n("003FFFFFFFFFFFFF",16),e.LOW_0=n("DB6DB6DB6DB6DB6D",16),e.LOW_1=n("F1F8FC7E3F1F8FC7",16),e.LOW_2=n("7FFFE00FFFFC01FF",16),e.LOW_3=n("FFC0000007FFFFFF",16),e.ROUNDS=27,e}();function T(e){for(var r=0,t=0,n=e;t<n.length;t++){r+=(u=n[t]).length}for(var i=new Int8Array(r),s=0,a=0,o=e;a<o.length;a++){var u=o[a];i.set(u,s),s+=u.length}return i}function w(e,r){if("public"!==e&&"private"!==e&&"restricted"!==e)throw new Error("The mode must be public, private or restricted, it is '"+e+"'");if("restricted"===e){if(!r)throw new Error("You must provide a sideKey for restricted mode");if(!t.isTrytes(r))throw new Error("The sideKey must be in trytes");if(r.length>81)throw new Error("The sideKey must be maximum length 81 trytes")}if("restricted"!==e&&r)throw new Error("sideKey is only used in restricted mode")}function y(e){var r=new i(81);r.absorb(e,0,e.length);var t=new Int8Array(i.HASH_LENGTH);return r.squeeze(t,0,t.length),t}function E(e,r){for(var t=r.rate(),n=Math.ceil(e.length/i.HASH_LENGTH),s=0;s<n;s++){var a=e.slice(s*i.HASH_LENGTH,(s+1)*i.HASH_LENGTH);r.absorb(a,0,a.length);for(var o=r.rate(),u=0;u<a.length;u++)e[s*i.HASH_LENGTH+u]=A(a[u],t[u]),t[u]=o[u]}return e}function p(e,r){for(var t,n=new Int8Array(e),s=Math.ceil(n.length/i.HASH_LENGTH)*i.HASH_LENGTH,a=0;a<s;a++){var o=a%i.HASH_LENGTH;0===o&&(t=r.rate()),t&&(n[a]=A(n[a],-t[o])),o===i.HASH_LENGTH-1&&r.absorb(n,Math.floor(a/i.HASH_LENGTH)*i.HASH_LENGTH,i.HASH_LENGTH)}return n}function A(e,r){var t=e+r;switch(t){case 2:return-1;case-2:return 1;default:return t}}
/*! *****************************************************************************
Copyright (c) Microsoft Corporation. All rights reserved.
Licensed under the Apache License, Version 2.0 (the "License"); you may not use
this file except in compliance with the License. You may obtain a copy of the
License at http://www.apache.org/licenses/LICENSE-2.0

THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
MERCHANTABLITY OR NON-INFRINGEMENT.

See the Apache Version 2.0 License for specific language governing permissions
and limitations under the License.
***************************************************************************** */
var _=function(){return(_=Object.assign||function(e){for(var r,t=1,n=arguments.length;t<n;t++)for(var i in r=arguments[t])Object.prototype.hasOwnProperty.call(r,i)&&(e[i]=r[i]);return e}).apply(this,arguments)};function L(e,r,t,n){return new(t||(t=Promise))((function(i,s){function a(e){try{u(n.next(e))}catch(e){s(e)}}function o(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){e.done?i(e.value):new t((function(r){r(e.value)})).then(a,o)}u((n=n.apply(e,r||[])).next())}))}function F(e,r){var t,n,i,s,a={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return s={next:o(0),throw:o(1),return:o(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function o(s){return function(o){return function(s){if(t)throw new TypeError("Generator is already executing.");for(;a;)try{if(t=1,n&&(i=2&s[0]?n.return:s[0]?n.throw||((i=n.return)&&i.call(n),0):n.next)&&!(i=i.call(n,s[1])).done)return i;switch(n=0,i&&(s=[2&s[0],i.value]),s[0]){case 0:case 1:i=s;break;case 4:return a.label++,{value:s[1],done:!1};case 5:a.label++,n=s[1],s=[0];continue;case 7:s=a.ops.pop(),a.trys.pop();continue;default:if(!(i=a.trys,(i=i.length>0&&i[i.length-1])||6!==s[0]&&2!==s[0])){a=0;continue}if(3===s[0]&&(!i||s[1]>i[0]&&s[1]<i[3])){a.label=s[1];break}if(6===s[0]&&a.label<i[1]){a.label=i[1],i=s;break}if(i&&a.label<i[2]){a.label=i[2],a.ops.push(s);break}i[2]&&a.ops.pop(),a.trys.pop();continue}s=r.call(e,a)}catch(e){s=[6,e],n=0}finally{t=i=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,o])}}}function S(e,t,n){var a=r.trits(e),o=r.trits(t),u=r.trits(n||"9".repeat(81)),l=H(a),h=l.value,f=H(a.slice(l.end)),d=f.value,v=l.end+f.end,g=v+i.HASH_LENGTH,b=g+d,T=new i(27);T.absorb(u,0,u.length),T.absorb(o,0,o.length),T.absorb(a,0,v);var w,y=p(a.slice(v,v+i.HASH_LENGTH),T),E=p(a.slice(g,g+d),T),A=p(a.slice(b,b+i.HASH_LENGTH/3),T),_=T.rate(),L=0===(w=_).slice(0,i.HASH_LENGTH/3).reduce((function(e,r){return e+r}),0)?1:0===w.slice(0,2*i.HASH_LENGTH/3).reduce((function(e,r){return e+r}),0)?2:0===w.reduce((function(e,r){return e+r}),0)?3:0;if(0===L)throw new Error("Message Hash did not have a hamming weight of zero, security level is invalid");var F=p(a.slice(b+A.length),T);T.reset();var S=function(e,r){for(var t=new i(27),n=new Int8Array(r.length),s=0;s<r.length/i.HASH_LENGTH;s++){for(var a=r.slice(s*i.HASH_LENGTH,(s+1)*i.HASH_LENGTH),o=0;o<e[3*s]+3*e[3*s+1]+9*e[3*s+2]- -13;o++)t.reset(),t.absorb(a,0,a.length),a=t.rate();n.set(a,s*i.HASH_LENGTH)}return t.reset(),t.absorb(n,0,n.length),t.rate()}(_,F.slice(0,L*s));T.absorb(S,0,S.length);var N=H(F.slice(L*s)),G=N.value,m=T.rate();if(0!==G){var I=L*s+N.end,M=F.slice(I,I+G*i.HASH_LENGTH);m=c.root(m,M,h)}if(r.trytes(m)!==t)throw new Error("Signature did not match expected root");return{nextRoot:r.trytes(y),message:r.trytes(E)}}function N(e,r,t,n){return L(this,void 0,Promise,(function(){var i;return F(this,(function(s){switch(s.label){case 0:return w(t,n),i=G(r,t),[4,e.findTransactionObjects({addresses:[i]})];case 1:return[2,m(s.sent(),i,r,n)]}}))}))}function G(e,t){return"public"===t?e:r.trytes(y(r.trits(e)))}function m(e,r,t,n){return L(this,void 0,Promise,(function(){var i,s,a,o,u;return F(this,(function(l){if(!e||0===e.length)return[2];for(i=e.filter((function(e){return 0===e.currentIndex})),s=e.filter((function(e){return 0!==e.currentIndex})),a=function(e){for(var a=i[e].signatureMessageFragment,o=i[e],u=0;u<i[e].lastIndex;u++){var l=s.find((function(e){return e.hash===o.trunkTransaction}));if(!l)break;if(a+=l.signatureMessageFragment,o=l,u===i[e].lastIndex-1)try{var c=S(a,t,n);return{value:_(_({root:t},c),{tag:i[e].tag})}}catch(e){throw new Error("Failed while trying to read MAM channel from address "+r+".\n"+e.message)}}},o=0;o<i.length;o++)if("object"==typeof(u=a(o)))return[2,u.value];return[2]}))}))}e.channelRoot=function(e){if(!e)throw new Error("channelState must be provided");if(e.start<0)throw new Error("channelState.start must be >= 0");if(e.count<=0)throw new Error("channelState.count must be > 0");if(e.security<1||e.security>3)throw new Error("channelState.security must be between 1 and 3, it is "+e.security);var t=new c(e.seed,e.start,e.count,e.security);return r.trytes(t.root.addressTrits)},e.createChannel=function(e,r,n,i){if(!t.isTrytesOfExactLength(e,81))throw new Error("The seed must be 81 trytes long");if(r<1||r>3)throw new Error("Security must be between 1 and 3, it is "+r);return w(n,i),{seed:e,mode:n,sideKey:"restricted"===n?(i||"").padEnd(81,"9"):void 0,security:r,start:0,count:1,nextCount:1,index:0}},e.createMessage=function(e,n){if(!t.isTrytes(n))throw new Error("The message must be in trytes");var s=new c(e.seed,e.start,e.count,e.security),a=new c(e.seed,e.start+e.count,e.nextCount,e.security).root.addressTrits,o=r.trits(n),u=f(e.index),l=f(o.length),h=s.getSubtree(e.index),H=new i(27),d=r.trits(e.sideKey||"9".repeat(81));H.absorb(d,0,d.length),H.absorb(s.root.addressTrits,0,s.root.addressTrits.length);var v=T([u,l]);H.absorb(v,0,v.length);var g=E(T([a,o]),H);v=T([v,g]);var w=(new b).search(H.rate(i.STATE_LENGTH),e.security,i.HASH_LENGTH/3,0);E(w,H),v=T([v,w]);var p=function(e,r){for(var t=new Int8Array(r.length),n=new i(27),s=0;s<r.length/i.HASH_LENGTH;s++){for(var a=r.subarray(s*i.HASH_LENGTH,(s+1)*i.HASH_LENGTH),o=0;o<13-(e[3*s]+3*e[3*s+1]+9*e[3*s+2]);o++)n.reset(),n.absorb(a,0,a.length),a=n.rate();t.set(a,s*i.HASH_LENGTH)}return t}(H.rate(),h.key),A=T(h.leaves.map((function(e){return e.addressTrits}))),_=E(T([p,f(A.length/i.HASH_LENGTH),A]),H),L=(v=T([v,_])).length%3;0!==L&&(v=T([v,new Int8Array(3-L).fill(0)]));var F="public"===e.mode?s.root.addressTrits:y(s.root.addressTrits),S={payload:r.trytes(v),root:r.trytes(s.root.addressTrits),address:r.trytes(F)};return e.index===e.count-1?(e.start=e.nextCount+e.start,e.index=0):e.index++,e.nextRoot=r.trytes(a),S},e.decodeAddress=G,e.decodeTransactions=m,e.mamAttach=function(e,r,t,n,i){return L(this,void 0,Promise,(function(){var s,a;return F(this,(function(o){switch(o.label){case 0:return s=[{address:r.address,value:0,message:r.payload,tag:i}],[4,e.prepareTransfers("9".repeat(81),s)];case 1:return a=o.sent(),[2,e.sendTrytes(a,t,n)]}}))}))},e.mamFetch=N,e.mamFetchAll=function(e,r,t,n,i){return L(this,void 0,Promise,(function(){var s,a,o,u;return F(this,(function(l){switch(l.label){case 0:w(t,n),s=void 0===i?Number.MAX_VALUE:i,a=[],o=r,l.label=1;case 1:return[4,N(e,o,t,n)];case 2:(u=l.sent())?(a.push(u),o=u.nextRoot):o=void 0,l.label=3;case 3:if(o&&a.length<s)return[3,1];l.label=4;case 4:return[2,a]}}))}))},e.mamFetchCombined=function(e,t){return L(this,void 0,Promise,(function(){var n,i,s,a,o;return F(this,(function(u){switch(u.label){case 0:return n=t.map((function(e){return"public"===e.mode?e.root:r.trytes(y(r.trits(e.root)))})),[4,e.findTransactionObjects({addresses:n})];case 1:i=u.sent(),s=[],a=function(e){var r,a;return F(this,(function(o){switch(o.label){case 0:return a=(r=s).push,[4,m(i.filter((function(r){return r.address===n[e]})),n[e],t[e].root,t[e].sideKey)];case 1:return a.apply(r,[o.sent()]),[2]}}))},o=0,u.label=2;case 2:return o<n.length?[5,a(o)]:[3,5];case 3:u.sent(),u.label=4;case 4:return o++,[3,2];case 5:return[2,s]}}))}))},e.parseMessage=S,Object.defineProperty(e,"__esModule",{value:!0})}));
