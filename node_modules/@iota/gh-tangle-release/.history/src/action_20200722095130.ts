import { getInput, setFailed, setOutput } from "@actions/core";
import { context } from "@actions/github";
import { tangleRelease } from "./core";
import { IPartialConfig } from "./models/IPartialConfig";

if (require.main === module) {
    console.log("Tangle Release Starting");

    const releaseTag = getInput("tag_name", { required: true });
    const comment = getInput("comment", { required: false });

    const { owner, repo } = context.repo;

    const envConfig: IPartialConfig = {
        githubToken: process.env.GITHUB_TOKEN,
        tangleExplorer: process.env.IOTA_TANGLE_EXPLORER,
        node: process.env.IOTA_NODE,
        depth: process.env.IOTA_DEPTH,
        mwm: process.env.IOTA_MWM,
        seed: process.env.IOTA_SEED,
        transactionTag: process.env.IOTA_TAG,
        addressIndex: process.env.IOTA_ADDRESS_INDEX,
        releaseTag: releaseTag,
        comment,
        owner,
        repository: repo
    };

    tangleRelease(envConfig)
        .then(transactionDetails => {
            setOutput("tx_hash", transactionDetails.hash);
            setOutput("tx_explore_url", transactionDetails.url);
            console.log("Complete");
        })
        .catch(err => {
            setFailed(err.message);
            console.log("Failed");
            console.log(err);
        });
}
